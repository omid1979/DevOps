با توجه به اینکه بسته نرم‌افزاری روی سرور دبین (Debian) راه‌اندازی می‌شود و از Webmin برای رابط کاربری استفاده می‌کنید، و همچنین نیاز به طراحی صفحات سفارشی برای Webmin و راه‌اندازی سرورهای اصلی دیتاسنتر (GitLab، Ansible، Cockpit) به‌صورت داکری دارید، در ادامه یک راهکار جامع برای پیاده‌سازی سریع این سرورها با Docker، نقشه معماری شبکه، و پیشنهادات برای مستندسازی ارائه می‌کنم.

---

### **راهکار راه‌اندازی سرورهای اصلی دیتاسنتر با Docker**

برای راه‌اندازی سرورهای GitLab، Ansible، و Cockpit در دیتاسنتر مرکزی به‌صورت داکری، استفاده از **Docker Compose** بهترین گزینه است، زیرا مدیریت چندین کانتینر را ساده می‌کند و پیکربندی‌ها را به‌صورت متمرکز نگه می‌دارد. در ادامه، مراحل و نمونه فایل Docker Compose برای راه‌اندازی این سرورها ارائه شده است.

#### **مراحل کلی**
1. **نصب Docker و Docker Compose روی سرور Debian**:
   - اطمینان حاصل کنید که سرور Debian شما به‌روز است (`sudo apt update && sudo apt upgrade`).
   - نصب Docker:
     ```bash
     sudo apt install docker.io
     sudo systemctl enable --now docker
     ```
   - نصب Docker Compose:
     ```bash
     sudo apt install docker-compose
     ```
2. **ایجاد فایل Docker Compose**:
   - یک فایل `docker-compose.yml` برای تعریف سرویس‌های GitLab، Ansible، و Cockpit ایجاد کنید.
   - هر سرویس باید به‌صورت ایزوله و با شبکه اختصاصی (bridge network) اجرا شود.
3. **پیکربندی ذخیره‌سازی و امنیت**:
   - از volume‌های Docker برای ذخیره‌سازی دائمی داده‌ها (مانند دیتابیس GitLab و فایل‌های پیکربندی) استفاده کنید.
   - تنظیم فایروال (UFW یا iptables) برای محدود کردن دسترسی به پ P ort‌ها.
4. **راه‌اندازی و تست**:
   - اجرای `docker-compose up -d` برای راه‌اندازی کانتینرها.
   - بررسی لاگ‌ها (`docker-compose logs`) و تست دسترسی به سرویس‌ها.

#### **نمونه فایل Docker Compose**
```yaml
version: '3.8'
services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: gitlab
    hostname: gitlab
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://gitlab.example.com'
        gitlab_rails['gitlab_shell_ssh_port'] = 2222
    ports:
      - "80:80"
      - "443:443"
      - "2222:22"
    volumes:
      - gitlab-config:/etc/gitlab
      - gitlab-logs:/var/log/gitlab
      - gitlab-data:/var/opt/gitlab
    networks:
      - app-network
    restart: always

  ansible:
    image: ansible/ansible-runner:latest
    container_name: ansible
    volumes:
      - ansible-data:/ansible
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - app-network
    restart: always
    command: tail -f /dev/null  # Keep container running for manual playbook execution

  cockpit:
    image: cockpit/cockpit:latest
    container_name: cockpit
    ports:
      - "9090:9090"
    volumes:
      - /:/host:ro
    privileged: true
    networks:
      - app-network
    restart: always

volumes:
  gitlab-config:
  gitlab-logs:
  gitlab-data:
  ansible-data:

networks:
  app-network:
    driver: bridge
```

#### **توضیحات فایل Docker Compose**
- **GitLab**:
  - از تصویر رسمی `gitlab-ce` استفاده می‌شود.
  - پورت‌های 80 (HTTP)، 443 (HTTPS)، و 2222 (SSH) برای دسترسی تنظیم شده‌اند.
  - volume‌ها برای ذخیره دائمی پیکربندی‌ها، لاگ‌ها، و داده‌ها تعریف شده‌اند.
  - متغیر `external_url` باید با آدرس واقعی سرور جایگزین شود.
- **Ansible**:
  - از تصویر `ansible/ansible-runner` استفاده می‌شود که ابزارهای لازم برای اجرای playbook‌ها را دارد.
  - volume برای ذخیره playbook‌ها و فایل‌های پیکربندی تعریف شده است.
  - اتصال به Docker socket برای مدیریت کانتینرها (در صورت نیاز) فراهم شده است.
- **Cockpit**:
  - از تصویر رسمی `cockpit/cockpit` برای مانیتورینگ سرور استفاده می‌شود.
  - پورت 9090 برای دسترسی به رابط وب Cockpit تنظیم شده است.
  - حالت privileged برای دسترسی به سیستم میزبان لازم است.
- **شبکه**:
  - یک شبکه bridge به نام `app-network` برای ارتباط بین سرویس‌ها تعریف شده است.

#### **دستورات راه‌اندازی**
1. فایل `docker-compose.yml` را در یک دایرکتوری (مثل `/opt/datacenter`) ذخیره کنید.
2. دستورات زیر را اجرا کنید:
   ```bash
   cd /opt/datacenter
   sudo docker-compose up -d
   ```
3. دسترسی به سرویس‌ها را تست کنید:
   - GitLab: `http://<server-ip>`
   - Cockpit: `http://<server-ip>:9090`
   - Ansible: با ورود به کانتینر (`docker exec -it ansible bash`) و اجرای playbook‌ها.

#### **نکات امنیتی**
- **فایروال**: فقط پورت‌های موردنیاز (80، 443، 2222 برای GitLab و 9090 برای Cockpit) را باز نگه دارید.
- **SSL/TLS**: برای GitLab و Cockpit، گواهی SSL (مثل Let’s Encrypt) تنظیم کنید.
- **دسترسی محدود**: دسترسی به Ansible را فقط از طریق SSH یا VPN محدود کنید.
- **بک‌آپ**: از volume‌های Docker به‌صورت دوره‌ای بک‌آپ بگیرید.

---

### **نقشه معماری شبکه**

برای طراحی معماری شبکه، با توجه به توضیحات شما، یک توپولوژی توزیع‌شده با تمرکز بر مقیاس‌پذیری و HA ارائه می‌شود. در ادامه، توضیح متنی و دیاگرام معماری ارائه شده است.

#### **توضیح معماری**
- **شعب**:
  - هر شعبه دو روتر (برای HA) با سیستم‌عامل Debian و فایروال (مثل iptables یا nftables).
  - پیکربندی لوکال از طریق Webmin با صفحات سفارشی.
  - ارتباط با امور شعب استانی از طریق VPN (مثل WireGuard یا IPsec).
- **امور شعب استانی**:
  - پراکسی سبک (مثل Squid یا Nginx) برای مدیریت ترافیک محلی و کاهش بار دیتاسنتر مرکزی.
  - File Server و Nextcloud برای ذخیره‌سازی و اشتراک فایل‌ها.
  - اتصال به دیتاسنتر مرکزی از طریق VPN یا MPLS.
- **دیتاسنتر مرکزی**:
  - سرورهای GitLab، Ansible، و Cockpit به‌صورت داکری.
  - مدیریت متمرکز پیکربندی‌ها از طریق GitLab (ذخیره‌سازی) و Ansible (اعمال).
  - مانیتورینگ با Cockpit و ابزارهای اضافی (مثل Prometheus).
- **جریان داده**:
  - پیکربندی‌ها از GitLab به Ansible و سپس به روترهای شعب ارسال می‌شود.
  - ترافیک شبکه از شعب به امور استانی و سپس به دیتاسنتر مرکزی هدایت می‌شود.
  - پراکسی‌های استانی ترافیک غیرضروری را فیلتر می‌کنند.

#### **دیاگرام معماری (متن‌بنیاد)**

[دیتاسنتر مرکزی]
   ├── GitLab Server (پیکربندی‌ها)
   ├── Ansible Server (اتوماسیون)
   └── Cockpit Server (مانیتورینگ)
       └── (اتصال VPN/MPLS به امور شعب استانی)

[امور شعب استانی]
   ├── Proxy Server (Squid/Nginx)
   ├── File Server
   └── Nextcloud
       └── (اتصال VPN به شعب)

[شعبه 1]
   ├── Router 1 (Debian, Webmin, Firewall) --- HA --- Router 2
   └── (اتصال VPN به امور شعب استانی)

[شعبه 2]
   ├── Router 1 (Debian, Webmin, Firewall) --- HA --- Router 2
   └── (اتصال VPN به امور شعب استانی)
...
[شعبه N]
   ├── Router 1 (Debian, Webmin, Firewall) --- HA --- Router 2
   └── (اتصال VPN به امور شعب استانی)


#### **توضیح دیاگرام**
- **دیتاسنتر مرکزی**: شامل سرورهای اصلی که به‌صورت داکری اجرا می‌شوند و تمام پیکربندی‌ها را مدیریت می‌کنند.
- **امور شعب استانی**: نقش واسطه برای کاهش بار ترافیک و ارائه خدمات ذخیره‌سازی محلی.
- **شعب**: هر شعبه دو روتر برای HA دارد که با Webmin پیکربندی می‌شوند و از طریق VPN به امور استانی متصل‌اند.

#### **پیشنهاد برای پیاده‌سازی Webmin**
- **صفحات سفارشی Webmin**:
  - Webmin از ماژول‌های سفارشی پشتیبانی می‌کند. می‌توانید با زبان Perl یا Python صفحات جدیدی برای پیکربندی‌های خاص (مثل تنظیمات فایروال یا VPN) ایجاد کنید.
  - مراحل:
    1. نصب Webmin روی روترهای Debian:
       ```bash
       wget http://prdownloads.sourceforge.net/webadmin/webmin_2.111_all.deb
       sudo dpkg -i webmin_2.111_all.deb
       ```
    2. ایجاد ماژول سفارشی:
       - در دایرکتوری `/usr/share/webmin` یک ماژول جدید بسازید (مثل `custom_router_config`).
       - فایل‌های Perl یا HTML برای رابط کاربری و اسکریپت‌های اجرایی بنویسید.
       - مستندات Webmin (http://www.webmin.com/docs.html) را برای توسعه ماژول بررسی کنید.
  - **پیشنهاد جایگزین**: اگر توسعه صفحات Webmin پیچیده است، از یک رابط وب ساده مبتنی بر Flask (Python) استفاده کنید که روی روترها اجرا شود و با Webmin ادغام شود.
- **امنیت Webmin**:
  - فقط از HTTPS استفاده کنید (گواهی SSL تنظیم شود).
  - دسترسی به Webmin را به IP‌های خاص محدود کنید.

---

### **پیشنهادات برای مستندسازی طراحی**

برای مستندسازی طراحی پروژه، یک پایگاه دانش متمرکز و ساخت‌یافته ضروری است. پیشنهادات:
1. **ابزار مستندسازی**:
   - **GitLab Wiki**: برای ذخیره‌سازی مستندات فنی و نسخه‌بندی آن‌ها.
   - **MkDocs یا Sphinx**: برای ایجاد مستندات Markdown یا reStructuredText که به‌صورت HTML رندر شوند.
   - **Confluence** (در صورت دسترسی): برای مستندات غیرفنی و همکاری تیمی.
2. **ساختار مستندات**:
   - **بخش معماری**:
     - دیاگرام‌های شبکه (مثل دیاگرام بالا) با ابزارهایی مثل Draw.io یا Lucidchart.
     - توضیحات معماری (شعب، امور استانی، دیتاسنتر).
   - **بخش نصب و راه‌اندازی**:
     - راهنمای نصب Debian و Webmin روی روترها.
     - راهنمای راه‌اندازی سرورهای داکری (GitLab، Ansible، Cockpit).
   - **بخش پیکربندی**:
     - مستندات پیکربندی Webmin و ماژول‌های سفارشی.
     - مستندات playbook‌های Ansible و ساختار repositoryهای GitLab.
   - **بخش مانیتورینگ و نگهداری**:
     - راهنمای استفاده از Cockpit.
     - دستورالعمل‌های بک‌آپ و به‌روزرسانی.
   - **بخش پشتیبانی**:
     - پایگاه دانش مشکلات رایج و راه‌حل‌ها.
     - راهنمای عیب‌یابی (Troubleshooting Guide).
3. **فرمت مستندات**:
   - استفاده از Markdown برای مستندات فنی.
   - خروجی PDF برای مستندات آفلاین.
   - دیاگرام‌ها در فرمت SVG یا PNG.
4. **نسخه‌بندی**:
   - تمام مستندات در GitLab نسخه‌بندی شوند.
   - تغییرات مهم با changelog مستند شوند.
5. **دسترسی**:
   - مستندات فنی فقط برای تیم‌های فنی در دسترس باشد (از طریق GitLab).
   - مستندات کاربر (مثل راهنمای Webmin) برای کاربران شعب در دسترس باشد.

#### **نمونه مستند معماری**

# مستند معماری شبکه

## نمای کلی
این پروژه یک شبکه توزیع‌شده برای شعب، امور شعب استانی، و دیتاسنتر مرکزی طراحی می‌کند. هدف، ارائه خدمات شبکه‌ای با قابلیت اطمینان بالا (HA) و مدیریت متمرکز است.

## اجزای اصلی
1. **دیتاسنتر مرکزی**:
   - **GitLab**: ذخیره‌سازی پیکربندی‌ها.
   - **Ansible**: اتوماسیون پیکربندی.
   - **Cockpit**: مانیتورینگ سرورها.
2. **امور شعب استانی**:
   - **Proxy Server**: کاهش بار ترافیک.
   - **File Server و Nextcloud**: ذخیره‌سازی و اشتراک فایل‌ها.
3. **شعب**:
   - دو روتر Debian با Webmin و فایروال.
   - ارتباط HA با VRRP یا Keepalived.

## دیاگرام شبکه
![Network Diagram](network_diagram.png)

## جریان داده
1. پیکربندی‌ها از GitLab به Ansible ارسال می‌شوند.
2. Ansible پیکربندی‌ها را به روترهای شعب اعمال می‌کند.
3. ترافیک شعب از طریق پراکسی‌های استانی به دیتاسنتر مرکزی هدایت می‌شود.

## نکات امنیتی
- استفاده از VPN (WireGuard/IPsec) برای ارتباطات.
- محدود کردن دسترسی به Webmin و سرورهای دیتاسنتر.
- بک‌آپ دوره‌ای از داده‌های GitLab و Ansible.


---

### **جمع‌بندی**
- **راه‌اندازی سرورها**: استفاده از Docker Compose برای راه‌اندازی سریع GitLab، Ansible، و Cockpit با پیکربندی ارائه‌شده.
- **معماری شبکه**: یک سیستم توزیع‌شده با HA در شعب، پراکسی‌های استانی، و مدیریت متمرکز در دیتاسنتر.
- **مستندسازی**: استفاده از GitLab Wiki یا MkDocs برای مستندات ساخت‌یافته با دیاگرام‌های واضح و نسخه‌بندی.
- **Webmin**: توسعه ماژول‌های سفارشی یا استفاده از Flask برای رابط کاربری ساده‌تر.

